<?php
//
/**
 * Implements hook_menu().
 */
function mp_service_menu() {
  $items['mp_service'] = array(
    'title' => 'valid&response',
    'page callback' => 'mp_service_response',
    'access callback' => TRUE,
  );
  $items['admin/config/mp_service'] = array(
    'title' => 'mp_service settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('mp_service_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'mp_service.admin.inc',
  );
  return $items;
}

function my_module_function($last_reply_code=0) {
  global $user;
  $my_data = &drupal_static(__FUNCTION__);
  if (!isset($my_data)) {
    if ($cache = cache_get('mp_service_'.$user->uid)) {
      $my_data = $cache->data;
    }
    else {
      // Do your expensive calculations here, and populate $my_data
      // with the correct stuff..
      // cache_set('my_module_data', $my_data, 'cache');
      cache_set('mp_service_'.$user->uid, $my_data, 'cache_mp_service', time() + 60);//1分钟内回复有效
    }
  }
  return $my_data;
}

function mp_service_response() {
  module_load_include('inc', 'mp_service', 'mp_service');
  $options = array(
    'token'=> variable_get('mp_service_token', 'ybzx'),//填写你设定的key
  );
  $wechatObj = new Wechat($options);
  // $wechatObj->valid(); //注意, 应用验证通过后,可将此句注释掉, 但会降低网站安全性
  $type = $wechatObj->getRev()->getRevType();
  $FromUserName =  $wechatObj->getRev()->getRevFrom();
  switch($type) {
    case Wechat::MSGTYPE_TEXT:
     
      $keyword =  trim($wechatObj->getRevContent());
      switch ($keyword) {
        case '00':
          $contentStr = "【1】玩法介绍\n【2】发布相片/心情\n【3】查看最近活跃的弟兄姊妹\n测试开发中～敬请期待！";
          break;
        case '1':
          $contentStr ="通过微信玩转永不止息？\n如果您有永不止息帐号\n请回复【9】绑定后更多玩法。\n回复【00】进入主菜单\n 测试开发中～敬请期待！";
          break;
        case '2':
          $contentStr = "【20】发布照片\n【21】想对你说(写给喜欢的人)\n【22】无主情话(随便说点情话)\n【23】时光隧道(分享我的过去)\n【24】独居生活(记录现在的生活)\n回复【00】进入主菜单\n 测试开发中～敬请期待！";
          break;
        case '3':
          $contentStr =  "【3】查看最近活跃的弟兄姊妹有：\n回复【00】进入主菜单\n 测试开发中～敬请期待！";
          break;
        case '9':
          $contentStr =  "就要绑定，请回复\n【91昵称?手机后四位】 \n》比如：91活水泉?1407\n》91后面的为您的昵称。\n【900】如何查看用户昵称\n【901】如何查看手机信息";
          break;
        case '900':
          $contentStr =  "Q:如何查看用户昵称？\n A:首页点击右侧个人头像，进入个人页面，点击完善信息，在浏览器上看到一个数字就是你的ID，？\n回复【9】返回绑定菜单，回复【00】返回主菜单";
          break;
        case '901':
          $contentStr =  "Q:如何查看手机信息？\n A:一般注册的时候填写的\n如果在注册时没有填写，您可以到个人页面，点击：编辑->基本信息。\n回复【9】返回绑定菜单\n回复【00】返回主菜单";
          break;

        case '911':
          $contentStr =  "我很忙，但很愿意为您服务，请加bluesky_still把您使用到的问题发给我。\n回复【00】返回主菜单";
          break;
        default:
            $contentStr = t('Thanks for your focus~,we will do our best for you!')."\n 测试开发中～敬请期待！";
            if(substr($keyword, 0,2)=='91') {
            $keyword = substr($keyword, 2);
            $keywords = explode('?', $keyword);

            if (!isset($keywords[1])) {
              $keywords = explode('？', $keyword);
            }
            $name = $keywords[0];
            if(strlen($keywords[1])!=4) {
              $contentStr = "手机后四位信息【".$keywords[1]."】不正确！\n回复【9】查看绑定帮助\n如需帮助，请回复【911】";
              // break;
            }
            $error_msg = user_validate_name($name);
            if(strlen($error_msg)>0){
              $contentStr = $error_msg;
              // break;
            }
            $account = user_load_by_name($name);
            if(!$account) {
              $contentStr = "不存在用户名【".$name."】！\n回复【9】查看绑定帮助\n如需帮助，请回复【911】";
              // break;
            }else {
              $profile = profile2_load_by_user($account);
              $tel = $profile['main']->field_telephone[LANGUAGE_NONE][0]['value'];
              if(substr($tel, 7)!==$keywords[1]) {
                $contentStr = "手机后四位信息【".$keywords[1]."】匹配不正确！\n回复【9】查看绑定帮助\n如需帮助，请回复【911】";
                // break;
              }else {
                //if bind,or not
                $uid = mp_service_is_bind($account->uid);
                if($uid) {
                  $contentStr = "您的账户【".$account->name."】已绑定过！\n回复【9】查看绑定帮助\n如需帮助，请回复【911】";
                  // break;
                }else {
                  mp_service_bind_uid($FromUserName,$account->uid);
                  $contentStr = "恭喜您，【".$account->name."】绑定成功！！\n回复【00】进入主菜单";
                  // break;
                }
              }
            }
          }
          break;
      }
      $wechatObj->text($contentStr)->reply();
      exit;
      break;
    case Wechat::MSGTYPE_EVENT:
      watchdog('MSGTYPE_EVENT', 'MSGTYPE_EVENT', array(), WATCHDOG_NOTICE, 'link');
      $wechatObj->textEvent("欢迎关注[Smile],我们将不定期发送永不止息最新动态给您~\n通过微信玩转永不止息？\n回复【00】进入主菜单\n所有功能测试开发中～敬请期待！")->reply();
      break;
    case Wechat::MSGTYPE_IMAGE:
      $wechatObj->text("已收到您发送的图片！")->reply();
      break;
    default:
      $wechatObj->text("【1】玩法介绍\n【2】发布相片/心情\n【3】查看最近活跃的弟兄姊妹\n测试开发中～敬请期待！")->reply();
  }
  return;

  //preg to get key_words
  // $postStr = $GLOBALS["HTTP_RAW_POST_DATA"];
  // if (!empty($postStr)) {
  //   $postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);
  //   watchdog('mp-postObj', print_r($postObj,true), array(), WATCHDOG_NOTICE, 'link');
  //   //focus::SimpleXMLElement Object ( [ToUserName] => gh_e7d44148423c [FromUserName] => oNAD2jlAk0ZGHkgezd_MnQbGrBPM [CreateTime] => 1372159280 [MsgType] => event [Event] => subscribe [EventKey] => SimpleXMLElement Object ( ) )
  //   //receive::SimpleXMLElement Object ( [ToUserName] => gh_e7d44148423c [FromUserName] => oNAD2jlAk0ZGHkgezd_MnQbGrBPM [CreateTime] => 1372158829 [MsgType] => text [Content] => 看来 [MsgId] => 5893377295572656705 )
  //   $fromUsername = $postObj->FromUserName;
  //   $toUsername = $postObj->ToUserName;
  //   $keyword = trim($postObj->Content);
  //   $time = time();
  //   //subscribe begin
  //   if($postObj->MsgType == 'event' && $postObj->Event == 'subscribe') {
  //     $contentStr = "欢迎关注[Smile],我们将不定期发送永不止息最新动态给您~\n通过微信玩转永不止息？\n回复【00】进入主菜单\n所有功能测试开发中～敬请期待！";
  //     $msgType = "text";
  //     $resultStr = sprintf($textTpl, $fromUsername, $toUsername, $time, $msgType, $contentStr);
  //     echo $resultStr;
  //     exit;
  //   }
  // }

}

function mp_service_is_bind($uid) {
  $uid = db_query('SELECT uid FROM {mp_service} WHERE uid = :uid', array(':uid' => $uid))->fetchField();
  return $uid;
}

// and bind!
function mp_service_bind_uid($FromUserName,$bindUid) {
  $result = db_insert('mp_service')
    ->fields(array(
      'uid' => $bindUid,
      'fromusername' => $FromUserName,
      'created' => REQUEST_TIME,
    ))
    ->execute();
}